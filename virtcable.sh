#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∏–º—è –¥–ª—è –≤–∞—à–µ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
SINK_NAME="Virtual-Mic"
# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
DEFAULT_DESCRIPTION="–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω"

# --- –§–£–ù–ö–¶–ò–ò ---

## 1. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–∞–±–µ–ª—è
function setup_virtual_mic() {
    if pactl list short modules | grep -q "sink_name=$SINK_NAME"; then
        echo "‚ö†Ô∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–∞–±–µ–ª—å '$SINK_NAME' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        return
    fi

    echo "üéôÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏–æ–∫–∞–±–µ–ª—è..."
    pactl load-module module-null-sink \
        sink_name="$SINK_NAME" \
        sink_properties=device.description="$DEFAULT_DESCRIPTION"
    echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–∞–±–µ–ª—å '$DEFAULT_DESCRIPTION' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω."
}

## 2. –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–±–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ (SINK_NAME)
function remove_virtual_mic() {
    echo "üóëÔ∏è  –ü–æ–∏—Å–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–∞–±–µ–ª—è —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∏–º–µ–Ω–µ–º '$SINK_NAME'..."
    MODULE_INDEX=$(pactl list short modules | grep "sink_name=$SINK_NAME" | awk '{print $1}')

    if [[ -z "$MODULE_INDEX" ]]; then
        echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è '$SINK_NAME'."
    else
        echo "   -> –ù–∞–π–¥–µ–Ω –º–æ–¥—É–ª—å —Å ID: $MODULE_INDEX. –£–¥–∞–ª—è—é..."
        pactl unload-module "$MODULE_INDEX"
        echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–∞–±–µ–ª—å '$SINK_NAME' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω."
    fi
}

## 3. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫–∞–±–µ–ª–µ–π
function remove_all_virtual_mics() {
    echo "üí£ –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫–∞–±–µ–ª–µ–π (—Å–æ–∑–¥–∞–Ω–Ω—ã—Ö module-null-sink)..."

    # –ù–∞—Ö–æ–¥–∏–º –í–°–ï –∏–Ω–¥–µ–∫—Å—ã –º–æ–¥—É–ª–µ–π —Ç–∏–ø–∞ module-null-sink, –∞ –Ω–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∏–º–µ–Ω–∏
    MODULE_INDICES=$(pactl list short modules | grep "module-null-sink" | awk '{print $1}')

    if [[ -z "$MODULE_INDICES" ]]; then
        echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞–±–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£–¥–∞–ª—è—Ç—å –Ω–µ—á–µ–≥–æ."
        return
    fi

    echo "   -> –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ ID –º–æ–¥—É–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
    # –í—ã–≤–æ–¥–∏–º ID –≤ —Å—Ç–æ–ª–±–∏–∫ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
    echo "$MODULE_INDICES" | while read -r id; do echo "      - $id"; done

    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å
    for INDEX in $MODULE_INDICES; do
        echo "   -> –£–¥–∞–ª—è—é –º–æ–¥—É–ª—å —Å ID: $INDEX..."
        pactl unload-module "$INDEX"
    done

    echo "‚úÖ –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞–±–µ–ª–∏ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã."
}


## 4. –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
function rename_virtual_mic() {
    echo "‚úèÔ∏è  –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–∞–±–µ–ª—è..."
    if ! pactl list short sinks | grep -q "$SINK_NAME"; then
        echo "‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞–±–µ–ª—å (–ø—É–Ω–∫—Ç 1)."
        return
    fi
    read -p "   –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: " NEW_NAME
    if [[ -z "$NEW_NAME" ]]; then
        echo "‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
        return
    fi
    pactl update-sink-proplist "$SINK_NAME" device.description="$NEW_NAME"
    pactl update-source-proplist "$SINK_NAME.monitor" device.description="$NEW_NAME"
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ '$NEW_NAME'."
}

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
function main_menu() {
    while true; do
        echo
        echo "--- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º ---"
        echo "1. –°–æ–∑–¥–∞—Ç—å –∫–∞–±–µ–ª—å (—Å –∏–º–µ–Ω–µ–º '$SINK_NAME')"
        echo "2. –£–¥–∞–ª–∏—Ç—å –∫–∞–±–µ–ª—å (—Å –∏–º–µ–Ω–µ–º '$SINK_NAME')"
        echo "3. üí£ –£–¥–∞–ª–∏—Ç—å –í–û–û–ë–©–ï –í–°–ï –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞–±–µ–ª–∏"
        echo "4. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–∞–±–µ–ª—å (—Å –∏–º–µ–Ω–µ–º '$SINK_NAME')"
        echo "5. –í—ã–π—Ç–∏"
        echo "----------------------------------------"
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ [1-5]: " choice

        case $choice in
            1) setup_virtual_mic ;;
            2) remove_virtual_mic ;;
            3) remove_all_virtual_mics ;;
            4) rename_virtual_mic ;;
            5) echo "üëã –í—ã—Ö–æ–¥."; break ;;
            *) echo "‚ùóÔ∏è –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5." ;;
        esac
    done
}

main_menu
